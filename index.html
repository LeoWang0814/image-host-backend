<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GitHub Uploader / 图床</title>
  <style>
    :root{
      color-scheme: dark;
      --bg1:#0a1229;
      --bg2:#1e3a8a;
      --card: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --accent: #3b82f6;
      --success: #22c55e;
      --error: #ef4444;
      --warning: #f59e0b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC",
                   "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 20% 15%, rgba(59,130,246,.30), transparent 60%),
        radial-gradient(1000px 600px at 85% 80%, rgba(30,58,138,.40), transparent 55%),
        linear-gradient(135deg, var(--bg1), #0b1636 35%, var(--bg2));
      color:var(--text);
      overflow:hidden;
    }
    body::before{
      content:"";
      position:fixed; inset:0;
      background-image:
        linear-gradient(to right, rgba(255,255,255,.06) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.06) 1px, transparent 1px);
      background-size: 48px 48px;
      mask-image: radial-gradient(circle at 50% 35%, black 0%, transparent 65%);
      pointer-events:none;
      opacity:.9;
    }
    .card{
      width:min(920px, 92vw);
      padding:26px 28px 30px;
      border-radius:18px;
      background: var(--card);
      border: 1px solid var(--border);
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
    }
    .top-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:999px;
      border: 1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size:13px;
      letter-spacing:.3px;
    }
    .dot{
      width:9px; height:9px; border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 18px rgba(59,130,246,.85);
    }
    h1{
      margin:14px 0 6px;
      font-size: clamp(28px, 5vw, 40px);
      line-height:1.15;
    }
    p{
      margin:0;
      color: var(--muted);
      font-size: 15px;
      line-height:1.7;
    }
    .sep{
      margin:18px 0 16px;
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12.5px;
      color: rgba(255,255,255,.72);
      opacity:.95;
    }
    .repo-info{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.04);
      font-size:12px;
      color: var(--muted);
    }
    .btn{
      border:none;
      background: linear-gradient(135deg, rgba(59,130,246,.95), rgba(59,130,246,.65));
      color:white;
      padding:8px 14px;
      border-radius:10px;
      font-size:13px;
      cursor:pointer;
      box-shadow: 0 10px 30px rgba(59,130,246,.35);
      transition: transform .15s ease, box-shadow .15s ease, opacity .15s ease;
    }
    .btn:hover{
      transform: translateY(-2px);
      box-shadow: 0 14px 36px rgba(59,130,246,.45);
    }
    .btn.secondary{
      background: rgba(255,255,255,.10);
      color: var(--text);
      box-shadow:none;
      border:1px solid rgba(255,255,255,.12);
    }
    .btn.small{
      padding:6px 10px;
      font-size:12px;
      border-radius:8px;
    }
    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
      transform:none;
    }
    .drop-zone{
      margin-top:18px;
      border:1px dashed rgba(255,255,255,.35);
      border-radius:18px;
      padding:26px;
      text-align:center;
      background: rgba(255,255,255,.04);
      transition: all .18s ease;
    }
    .drop-zone.dragover{
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(59,130,246,.25);
      background: rgba(59,130,246,.08);
    }
    .drop-zone h3{
      margin:0 0 8px;
      font-size:18px;
    }
    .drop-zone p{
      color: var(--muted);
      font-size:14px;
    }
    .list-header{
      margin-top:20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .list{
      margin-top:12px;
      display:grid;
      gap:12px;
      max-height:360px;
      overflow:auto;
      padding-right:4px;
    }
    .item{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      padding:12px 14px;
      display:grid;
      gap:8px;
      box-shadow: 0 12px 30px rgba(0,0,0,.18);
    }
    .item-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .status-dot{
      width:10px;
      height:10px;
      border-radius:50%;
      background: var(--warning);
      box-shadow: 0 0 12px rgba(245,158,11,.6);
    }
    .status-dot.success{background: var(--success); box-shadow: 0 0 12px rgba(34,197,94,.6);}
    .status-dot.error{background: var(--error); box-shadow: 0 0 12px rgba(239,68,68,.6);}
    .status-dot.uploading{background: var(--accent); box-shadow: 0 0 12px rgba(59,130,246,.6);}
    .filenames{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .filenames span{
      font-size:12.5px;
      color: var(--muted);
    }
    .filenames strong{
      font-size:14px;
      color: var(--text);
      font-weight:600;
    }
    .progress{
      height:6px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
    }
    .progress > span{
      display:block;
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(59,130,246,.6), rgba(59,130,246,1));
      transition: width .2s ease;
    }
    .link{
      font-size:12px;
      color: rgba(147,197,253,.9);
      word-break:break-all;
    }
    .meta{
      font-size:12px;
      color: var(--muted);
    }
    .status-text{
      font-size:12px;
      color: var(--muted);
    }
    .error-text{
      color: rgba(248,113,113,.95);
    }
    .token-result{
      margin-top:10px;
      font-size:12px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <main class="card">
    <div class="top-row">
      <div class="badge"><span class="dot"></span>GitHub Uploader / 图床</div>
      <div class="repo-info">
        <div class="chip" id="repoDisplay"></div>
        <div class="chip" id="dirDisplay"></div>
        <button class="btn small" id="testTokenBtn">Test Token</button>
      </div>
    </div>
    <h1>GitHub 图床上传器</h1>
    <p>拖拽或选择文件，自动生成 UUID 文件名并上传到 GitHub 指定目录。</p>

    <div class="sep"></div>

    <section class="drop-zone" id="dropZone">
      <h3>拖拽文件到这里</h3>
      <p>或点击选择文件（支持多选）</p>
      <input id="fileInput" type="file" multiple hidden />
      <button class="btn" id="selectBtn">选择文件</button>
    </section>

    <div class="token-result" id="tokenResult"></div>

    <div class="list-header">
      <div class="mono">Queue · Concurrency <span id="concurrencyDisplay"></span></div>
      <button class="btn secondary small" id="copyAllBtn">一键复制全部链接</button>
    </div>

    <div class="list" id="uploadList"></div>
  </main>

  <script>
    const GITHUB_TOKEN = "YOUR-GITHUB-TOKEN";
    const REPO_OWNER = "YOUR-REPO-OWNER";
    const REPO_NAME  = "YOUR-REPO-NAME";
    const TARGET_DIR = "public/";
    const BRANCH     = "main";
    const COMMIT_MESSAGE_PREFIX = "upload:";
    const CONCURRENCY = 3;

    const repoDisplay = document.getElementById("repoDisplay");
    const dirDisplay = document.getElementById("dirDisplay");
    const concurrencyDisplay = document.getElementById("concurrencyDisplay");
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("fileInput");
    const selectBtn = document.getElementById("selectBtn");
    const uploadList = document.getElementById("uploadList");
    const copyAllBtn = document.getElementById("copyAllBtn");
    const testTokenBtn = document.getElementById("testTokenBtn");
    const tokenResult = document.getElementById("tokenResult");

    const queue = [];
    const items = [];
    let activeCount = 0;

    repoDisplay.textContent = `${REPO_OWNER}/${REPO_NAME}#${BRANCH}`;
    dirDisplay.textContent = `/${normalizeDir(TARGET_DIR)}`;
    concurrencyDisplay.textContent = CONCURRENCY;

    selectBtn.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", (event) => {
      if (event.target.files.length) {
        handleFiles(event.target.files);
        event.target.value = "";
      }
    });

    ["dragenter", "dragover"].forEach((evt) => {
      dropZone.addEventListener(evt, (event) => {
        event.preventDefault();
        event.stopPropagation();
        dropZone.classList.add("dragover");
      });
    });
    ["dragleave", "drop"].forEach((evt) => {
      dropZone.addEventListener(evt, (event) => {
        event.preventDefault();
        event.stopPropagation();
        dropZone.classList.remove("dragover");
      });
    });
    dropZone.addEventListener("drop", (event) => {
      const files = event.dataTransfer.files;
      if (files && files.length) {
        handleFiles(files);
      }
    });

    copyAllBtn.addEventListener("click", async () => {
      const links = items
        .filter((item) => item.status === "success")
        .map((item) => item.rawUrl)
        .join("\n");
      if (!links) {
        toastStatus("暂无可复制的链接", true);
        return;
      }
      await copyText(links);
      toastStatus("已复制全部链接");
    });

    testTokenBtn.addEventListener("click", async () => {
      tokenResult.textContent = "Token 验证中...";
      tokenResult.classList.remove("error-text");
      try {
        const response = await fetch("https://api.github.com/user", {
          headers: buildHeaders()
        });
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.message || "Token 无效");
        }
        tokenResult.textContent = `Token OK · ${data.login}`;
      } catch (error) {
        tokenResult.textContent = `Token Error · ${error.message}`;
        tokenResult.classList.add("error-text");
      }
    });

    function handleFiles(fileList) {
      Array.from(fileList).forEach((file) => {
        const uuidName = buildUuidFilename(file.name);
        const item = createItem(file, uuidName);
        items.push(item);
        queue.push(item);
        renderItem(item);
      });
      processQueue();
    }

    function normalizeDir(dir) {
      if (!dir) return "";
      let trimmed = dir.trim();
      if (!trimmed) return "";
      trimmed = trimmed.replace(/^\/+/, "");
      return trimmed.replace(/\/+$/, "") + "/";
    }

    function buildUuidFilename(originalName) {
      const uuid = generateUuid();
      const extIndex = originalName.lastIndexOf(".");
      const ext = extIndex > 0 ? originalName.slice(extIndex) : "";
      return `${uuid}${ext}`;
    }

    function generateUuid() {
      if (crypto.randomUUID) return crypto.randomUUID();
      const bytes = new Uint8Array(16);
      crypto.getRandomValues(bytes);
      bytes[6] = (bytes[6] & 0x0f) | 0x40;
      bytes[8] = (bytes[8] & 0x3f) | 0x80;
      const hex = Array.from(bytes).map((b) => b.toString(16).padStart(2, "0"));
      return `${hex.slice(0,4).join("")}-${hex.slice(4,6).join("")}-${hex.slice(6,8).join("")}-${hex.slice(8,10).join("")}-${hex.slice(10,16).join("")}`;
    }

    function createItem(file, uuidName) {
      const targetPath = `${normalizeDir(TARGET_DIR)}${uuidName}`;
      return {
        id: generateUuid(),
        file,
        originalName: file.name,
        uuidName,
        path: targetPath,
        status: "queued",
        progress: 0,
        rawUrl: buildRawUrl(targetPath),
        blobUrl: buildBlobUrl(targetPath),
        error: "",
        element: null,
      };
    }

    function buildRawUrl(path) {
      return `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/${BRANCH}/${path}`;
    }

    function buildBlobUrl(path) {
      return `https://github.com/${REPO_OWNER}/${REPO_NAME}/blob/${BRANCH}/${path}`;
    }

    function buildHeaders() {
      return {
        Authorization: `Bearer ${GITHUB_TOKEN}`,
        Accept: "application/vnd.github+json",
        "X-GitHub-Api-Version": "2022-11-28",
        "Content-Type": "application/json",
      };
    }

    function renderItem(item) {
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="item-row">
          <div style="display:flex; align-items:center; gap:10px;">
            <span class="status-dot"></span>
            <div class="filenames">
              <strong>${escapeHtml(item.originalName)}</strong>
              <span>${escapeHtml(item.uuidName)}</span>
            </div>
          </div>
          <div class="item-row" style="gap:8px;">
            <span class="status-text">队列中</span>
            <button class="btn secondary small retry-btn" style="display:none;">重试</button>
            <button class="btn secondary small copy-btn" style="display:none;">Copy</button>
          </div>
        </div>
        <div class="progress"><span></span></div>
        <div class="meta"></div>
      `;
      uploadList.prepend(el);
      item.element = el;
      wireItemButtons(item);
      updateItemUI(item);
    }

    function wireItemButtons(item) {
      const retryBtn = item.element.querySelector(".retry-btn");
      const copyBtn = item.element.querySelector(".copy-btn");
      retryBtn.addEventListener("click", () => {
        if (item.status === "error") {
          item.status = "queued";
          item.error = "";
          item.progress = 0;
          queue.push(item);
          updateItemUI(item);
          processQueue();
        }
      });
      copyBtn.addEventListener("click", async () => {
        await copyText(item.rawUrl);
        toastStatus("已复制链接");
      });
    }

    function updateItemUI(item) {
      const dot = item.element.querySelector(".status-dot");
      const statusText = item.element.querySelector(".status-text");
      const progressBar = item.element.querySelector(".progress span");
      const meta = item.element.querySelector(".meta");
      const retryBtn = item.element.querySelector(".retry-btn");
      const copyBtn = item.element.querySelector(".copy-btn");

      dot.className = "status-dot";
      retryBtn.style.display = "none";
      copyBtn.style.display = "none";

      if (item.status === "queued") {
        statusText.textContent = "队列中";
        progressBar.style.width = "0%";
        meta.textContent = "";
      } else if (item.status === "uploading") {
        statusText.textContent = "上传中";
        dot.classList.add("uploading");
        progressBar.style.width = `${item.progress}%`;
        meta.textContent = `目标: ${item.path}`;
      } else if (item.status === "success") {
        statusText.textContent = "成功";
        dot.classList.add("success");
        progressBar.style.width = "100%";
        meta.innerHTML = `
          <div class="link">RAW: <a href="${item.rawUrl}" target="_blank">${item.rawUrl}</a></div>
          <div class="link">Blob: <a href="${item.blobUrl}" target="_blank">${item.blobUrl}</a></div>
        `;
        copyBtn.style.display = "inline-flex";
      } else if (item.status === "error") {
        statusText.textContent = "失败";
        dot.classList.add("error");
        progressBar.style.width = "100%";
        meta.innerHTML = `<div class="error-text">${escapeHtml(item.error || "上传失败")}</div>`;
        retryBtn.style.display = "inline-flex";
      }
    }

    function processQueue() {
      while (activeCount < CONCURRENCY && queue.length) {
        const item = queue.shift();
        if (!item || item.status !== "queued") continue;
        uploadItem(item);
      }
    }

    async function uploadItem(item) {
      activeCount += 1;
      item.status = "uploading";
      item.progress = 10;
      updateItemUI(item);
      try {
        const content = await fileToBase64(item.file, (percent) => {
          item.progress = Math.max(10, Math.min(70, percent));
          updateItemUI(item);
        });
        const payload = {
          message: `${COMMIT_MESSAGE_PREFIX} ${item.originalName} -> ${item.uuidName}`,
          content,
          branch: BRANCH,
        };
        const url = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${item.path}`;
        const response = await fetch(url, {
          method: "PUT",
          headers: buildHeaders(),
          body: JSON.stringify(payload),
        });
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data.message || "上传失败");
        }
        item.status = "success";
        item.progress = 100;
        updateItemUI(item);
      } catch (error) {
        item.status = "error";
        item.error = error.message || "上传失败";
        updateItemUI(item);
      } finally {
        activeCount -= 1;
        processQueue();
      }
    }

    function fileToBase64(file, onProgress) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result;
          const base64 = result.split(",")[1];
          resolve(base64);
        };
        reader.onerror = () => reject(new Error("读取文件失败"));
        reader.onprogress = (event) => {
          if (event.lengthComputable && typeof onProgress === "function") {
            const percent = Math.round((event.loaded / event.total) * 100);
            onProgress(percent);
          }
        };
        reader.readAsDataURL(file);
      });
    }

    async function copyText(text) {
      try {
        await navigator.clipboard.writeText(text);
      } catch (error) {
        const textarea = document.createElement("textarea");
        textarea.value = text;
        textarea.style.position = "fixed";
        textarea.style.opacity = "0";
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
      }
    }

    function toastStatus(message, isError = false) {
      tokenResult.textContent = message;
      tokenResult.classList.toggle("error-text", isError);
      setTimeout(() => {
        if (tokenResult.textContent === message) {
          tokenResult.textContent = "";
        }
      }, 2400);
    }

    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }
  </script>
</body>
</html>